<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drachin - Drama Chino Stream</title>
    <meta name="description" content="Watch latest Chinese Drama for free.">
    <meta name="theme-color" content="#0f0f0f">
    
    <!-- Preconnect untuk mempercepat loading player -->
    <link rel="preconnect" href="https://www.dailymotion.com">
    <link rel="preconnect" href="https://api.dailymotion.com">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.263.1/dist/umd/lucide.min.js"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f0f0f; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #e50914; }

        body { background-color: #0f0f0f; color: #e5e5e5; font-family: 'Segoe UI', Roboto, sans-serif; }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .aspect-video-card {
            aspect-ratio: 16/9;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- NAVBAR -->
    <nav class="sticky top-0 z-50 bg-black/90 backdrop-blur-md border-b border-white/10">
        <div class="container mx-auto px-4 h-16 flex items-center justify-between gap-4">
            <a href="?" class="flex items-center gap-2 text-2xl font-bold tracking-tighter hover:scale-105 transition shrink-0">
                <span class="text-red-600">â–¶</span> Drachin
            </a>
            
            <div class="flex items-center gap-3 flex-1 justify-end md:justify-between">
                <!-- Search Bar -->
                <form id="searchForm" class="hidden md:flex flex-1 max-w-md mx-auto items-center bg-gray-800 rounded-full px-4 py-1.5 border border-gray-700 focus-within:border-red-600 transition">
                    <input type="text" id="searchInput" data-i18n-placeholder="searchPlaceholder" placeholder="Search drama or Paste ID..." class="bg-transparent border-none outline-none text-sm w-full text-white placeholder-gray-400">
                    <button type="submit" class="text-gray-400 hover:text-white"><i data-lucide="search" class="w-4 h-4"></i></button>
                </form>

                <!-- Language Selector (Only EN & ES) -->
                <div class="relative group">
                    <select id="langSelect" onchange="changeLanguage(this.value)" class="appearance-none bg-gray-900 border border-gray-700 text-white text-xs py-1.5 pl-3 pr-8 rounded-full focus:outline-none focus:border-red-600 cursor-pointer font-medium hover:bg-gray-800 transition">
                        <option value="en">ðŸ‡ºðŸ‡¸ EN</option>
                        <option value="es">ðŸ‡ªðŸ‡¸ ES</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
                        <i data-lucide="chevron-down" class="w-3 h-3"></i>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- CONTENT WRAPPER -->
    <!-- Hapus px-4 global agar player bisa full width di mobile -->
    <main class="flex-grow w-full max-w-[1400px] mx-auto">
        
        <!-- SEARCH MOBILE (Tambahkan padding manual) -->
        <div class="px-4 py-4 md:hidden">
            <form id="searchFormMobile" class="flex items-center bg-gray-800 rounded-full px-4 py-2 border border-gray-700">
                 <input type="text" id="searchInputMobile" data-i18n-placeholder="searchPlaceholder" placeholder="Search drama or Paste ID..." class="bg-transparent border-none outline-none text-sm w-full text-white placeholder-gray-400">
                 <button type="submit" class="text-gray-400 hover:text-white"><i data-lucide="search" class="w-4 h-4"></i></button>
            </form>
        </div>

        <!-- LOADING INDICATOR -->
        <div id="loader" class="hidden flex justify-center items-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-red-600 border-solid"></div>
        </div>

        <!-- VIEW: HOME (GRID) -->
        <!-- Tambahkan padding px-4 disini untuk Grid -->
        <div id="homeView" class="px-4 pb-6">
            <div class="flex items-center justify-between mb-6">
                <h2 id="pageTitle" class="text-xl md:text-2xl font-bold border-l-4 border-red-600 pl-3">Latest Chinese Dramas</h2>
            </div>
            
            <div id="videoGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6">
                <!-- Items will be injected here -->
            </div>
            
            <div class="mt-10 text-center">
                <button id="loadMoreBtn" onclick="loadMore()" class="px-6 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-full text-sm font-semibold transition border border-gray-600">
                    Load More
                </button>
            </div>
        </div>

        <!-- VIEW: PLAYER -->
        <div id="playerView" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-0 lg:gap-8">
            <div class="lg:col-span-2 space-y-0 lg:space-y-4">
                <!-- Tombol Back dengan padding -->
                <div class="px-4 py-2 lg:py-0">
                    <button onclick="goHome()" class="flex items-center text-gray-400 hover:text-white text-sm mb-2 transition">
                        <i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i> <span data-i18n="backBtn">Back</span>
                    </button>
                </div>
                
                <!-- Player Wrapper -->
                <!-- Di Mobile: w-full, tanpa rounded, tanpa border samping (Full Immersive) -->
                <!-- Di Desktop: rounded-xl, shadow -->
                <div class="relative w-full aspect-video bg-black lg:rounded-xl overflow-hidden shadow-2xl border-y border-gray-800 lg:border">
                    <iframe id="dmPlayer" class="absolute top-0 left-0 w-full h-full" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>
                </div>

                <!-- Video Info (Dengan Padding) -->
                <div class="bg-[#1a1a1a] p-4 lg:p-5 lg:rounded-xl border-b border-gray-800 lg:border">
                    <h1 id="playerTitle" class="text-lg md:text-2xl font-bold leading-snug mb-2 text-white">Loading info...</h1>
                    <div class="flex items-center gap-3 text-sm text-gray-400 mb-4">
                        <span class="bg-red-600 text-white px-2 py-0.5 rounded text-xs font-bold">DM</span>
                        <span id="playerOwner">...</span>
                        <span>â€¢</span>
                        <span id="playerViews">...</span>
                    </div>
                    <div class="flex gap-2 mb-6">
                        <!-- Tombol DOWNLOAD -->
                        <a id="downloadBtn" href="https://thinnerwithdrewforbear.com/gcjm4sfz6e?key=f12b44e51f20fb37ba29ae6253bff65a" target="_blank" class="flex-1 bg-gray-700 hover:bg-gray-600 text-center py-2 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i> <span data-i18n="watchOnDm">Download Video</span>
                        </a>
                        
                        <!-- Tombol Share -->
                        <button onclick="shareVideo()" class="flex-1 bg-red-600 hover:bg-red-700 text-center py-2 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2 active:scale-95">
                            <i data-lucide="share-2" class="w-4 h-4"></i> <span data-i18n="share">Share</span>
                        </button>
                    </div>

                    <!-- NATIVE BANNER ADSTERRA (Container Only) -->
                    <!-- Script akan di-inject via JS saat player muncul agar terbaca -->
                    <div class="mt-4 border-t border-gray-700 pt-4">
                         <div class="text-[10px] text-gray-500 mb-2 text-center tracking-widest uppercase">Sponsored</div>
                         <div id="ad-wrapper" class="flex justify-center min-h-[100px] bg-black/30 rounded-lg overflow-hidden relative">
                             <!-- Script iklan akan masuk disini -->
                             <div id="container-b94cafeb9a426597e421e6c2d836a415"></div>
                         </div>
                    </div>
                </div>
            </div>

            <!-- Recommendations (Dengan Padding) -->
            <div class="lg:col-span-1 px-4 lg:px-0 py-6 lg:py-0">
                <h3 class="text-lg font-bold mb-4 text-gray-200" data-i18n="recommendationTitle">Recommended Dramas</h3>
                <div id="recommendationList" class="flex flex-col gap-3">
                    <!-- List Items -->
                </div>
            </div>
        </div>

    </main>

    <!-- FOOTER -->
    <footer class="mt-12 py-8 bg-black border-t border-gray-800 text-center">
        <p class="text-gray-500 text-sm">&copy; 2025 Drachin Stream. All rights reserved.</p>
        
        <!-- Histats.com  START  (aync)-->
        <div id="histats_counter" style="display:none;"></div>
        <script type="text/javascript">var _Hasync= _Hasync|| [];
        _Hasync.push(['Histats.start', '1,4654540,4,0,0,0,00010000']);
        _Hasync.push(['Histats.fasi', '1']);
        _Hasync.push(['Histats.track_hits', '']);
        (function() {
        var hs = document.createElement('script'); hs.type = 'text/javascript'; hs.async = true;
        hs.src = ('//s10.histats.com/js15_as.js');
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(hs);
        })();</script>
        <noscript><a href="/" target="_blank"><img  src="//sstatic1.histats.com/0.gif?4654540&101" alt="" border="0"></a></noscript>
        <!-- Histats.com  END  -->
    </footer>

    <script>
        // === KONFIGURASI BAHASA (EN & ES) ===
        const CONFIG = {
            en: {
                query: "Chinese Drama Eng Sub",
                titleHome: "Latest Chinese Dramas",
                searchPlaceholder: "Search drama or Paste ID (e.g. x9n1o8e)",
                loadMore: "Load More",
                backBtn: "Back",
                watchOnDm: "Download Video", 
                share: "Share",
                copied: "Link copied to clipboard!",
                recommendationTitle: "Recommended Dramas",
                noResult: "No videos found.",
                loading: "Loading..."
            },
            es: {
                query: "Drama Chino Sub EspaÃ±ol",
                titleHome: "Dramas Chinos Recientes",
                searchPlaceholder: "Buscar drama o pegar ID (ej. x9n1o8e)",
                loadMore: "Cargar MÃ¡s",
                backBtn: "Volver",
                watchOnDm: "Descargar Video", 
                share: "Compartir",
                copied: "Â¡Enlace copiado al portapapeles!",
                recommendationTitle: "Dramas Recomendados",
                noResult: "No se encontraron videos.",
                loading: "Cargando..."
            }
        };

        let currentLang = 'en'; 
        let currentPage = 1;
        let currentQuery = CONFIG[currentLang].query;
        let isSearchMode = false;
        let isAdLoaded = false;
        
        const homeView = document.getElementById('homeView');
        const playerView = document.getElementById('playerView');
        const videoGrid = document.getElementById('videoGrid');
        const loader = document.getElementById('loader');
        const pageTitle = document.getElementById('pageTitle');
        const dmPlayer = document.getElementById('dmPlayer');
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        
        function refreshIcons() {
            setTimeout(() => {
                if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
            }, 100);
        }

        // === POPUNDER DELAYED (10 MENIT) ===
        function initPopunder() {
            console.log("Popunder timer started: 10 minutes");
            setTimeout(() => {
                var script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = 'https://thinnerwithdrewforbear.com/6d/d4/c7/6dd4c77770d65b1bcda88bbac1019b8a.js';
                document.body.appendChild(script);
                console.log("Popunder script loaded after 10 minutes.");
            }, 600000); 
        }

        // === FUNGSI LOAD IKLAN NATIVE ===
        // Dipanggil saat Player View muncul
        function loadNativeAd() {
            if(isAdLoaded) return; // Load sekali saja per sesi agar tidak spam
            
            const adWrapper = document.getElementById('ad-wrapper');
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.async = true;
            script.setAttribute('data-cfasync', 'false');
            script.src = 'https://thinnerwithdrewforbear.com/b94cafeb9a426597e421e6c2d836a415/invoke.js';
            
            adWrapper.appendChild(script);
            isAdLoaded = true;
            console.log("Native ad script injected.");
        }

        // === FUNGSI INIT & BAHASA ===
        function applyLanguageText(lang) {
            const textData = CONFIG[lang];
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(textData[key]) el.innerText = textData[key];
            });

            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if(textData[key]) el.placeholder = textData[key];
            });

            if (!isSearchMode) {
                pageTitle.innerText = textData.titleHome;
                currentQuery = textData.query;
            }
            loadMoreBtn.innerText = textData.loadMore;
        }

        function changeLanguage(lang) {
            currentLang = lang;
            applyLanguageText(lang);
            updateUrlState();

            if (playerView.classList.contains('hidden')) {
                currentPage = 1;
                videoGrid.innerHTML = '';
                loadHomeView();
            } else {
                loadRecommendations(getIdFromUrl() || 'x');
            }
        }

        async function init() {
            initPopunder(); 

            const urlParams = new URLSearchParams(window.location.search);
            const videoId = urlParams.get('id');
            const langParam = urlParams.get('lang');

            if (langParam && ['en', 'es'].includes(langParam)) {
                currentLang = langParam;
                document.getElementById('langSelect').value = currentLang;
            }
            
            applyLanguageText(currentLang);

            if (videoId) {
                await loadPlayerView(videoId);
            } else {
                loadHomeView();
            }
        }

        function updateUrlState(id = null) {
            try {
                const newUrl = new URL(window.location);
                if (id) newUrl.searchParams.set('id', id);
                else {
                    if (playerView.classList.contains('hidden')) newUrl.searchParams.delete('id');
                }
                newUrl.searchParams.set('lang', currentLang);

                if (id && id !== getIdFromUrl()) {
                    window.history.pushState({ path: newUrl.toString() }, '', newUrl.toString());
                } else {
                    window.history.replaceState({ path: newUrl.toString() }, '', newUrl.toString());
                }
            } catch (e) { /* ignore in preview */ }
        }

        // === FUNGSI UTAMA ===

        async function fetchDailymotion(query, page = 1) {
            const url = `https://api.dailymotion.com/videos?search=${encodeURIComponent(query)}&fields=id,title,thumbnail_720_url,owner.username,views_total,duration&limit=20&page=${page}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                return data.list || [];
            } catch (error) {
                return [];
            }
        }

        function renderCard(video) {
            const minutes = Math.floor(video.duration / 60);
            const seconds = video.duration % 60;
            const durationStr = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

            return `
                <div onclick="openPlayer('${video.id}')" class="group cursor-pointer bg-[#1e1e1e] rounded-lg overflow-hidden transition-all duration-300 hover:-translate-y-1 hover:shadow-xl hover:shadow-red-900/20 border border-transparent hover:border-gray-700">
                    <div class="relative aspect-video-card bg-gray-800 overflow-hidden">
                        <img src="${video.thumbnail_720_url}" alt="${video.title}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500 opacity-90 group-hover:opacity-100">
                        <div class="absolute bottom-2 right-2 bg-black/80 text-white text-[10px] px-1.5 py-0.5 rounded font-mono">
                            ${durationStr}
                        </div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                            <div class="bg-red-600 rounded-full p-3 shadow-lg scale-0 group-hover:scale-100 transition-transform">
                                <i data-lucide="play" class="w-5 h-5 fill-white text-white ml-0.5"></i>
                            </div>
                        </div>
                    </div>
                    <div class="p-3">
                        <h3 class="text-sm font-semibold text-gray-100 line-clamp-2 leading-snug group-hover:text-red-500 transition-colors">${video.title}</h3>
                        <div class="flex items-center justify-between mt-2 text-xs text-gray-500">
                            <span>${video['owner.username']}</span>
                            <span>${(video.views_total || 0).toLocaleString()} views</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSideItem(video) {
            return `
                <div onclick="openPlayer('${video.id}')" class="flex gap-3 p-2 rounded-lg hover:bg-gray-800 cursor-pointer transition group">
                    <div class="relative w-32 aspect-video flex-shrink-0 rounded overflow-hidden bg-gray-800">
                        <img src="${video.thumbnail_720_url}" class="w-full h-full object-cover group-hover:opacity-80 transition">
                    </div>
                    <div class="flex flex-col justify-center w-full overflow-hidden">
                        <h4 class="text-xs md:text-sm font-medium text-gray-200 line-clamp-2 group-hover:text-red-400 transition">${video.title}</h4>
                        <div class="flex items-center justify-between mt-1">
                            <p class="text-[10px] text-gray-500 truncate max-w-[80px]">${video['owner.username']}</p>
                            <p class="text-[10px] text-gray-600">${Math.floor(video.duration/60)}m</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadHomeView() {
            homeView.classList.remove('hidden');
            playerView.classList.add('hidden');
            loader.classList.remove('hidden');
            loadMoreBtn.classList.add('hidden');
            
            const videos = await fetchDailymotion(currentQuery, currentPage);
            
            let html = '';
            if(videos.length > 0) {
                videos.forEach(v => html += renderCard(v));
                if(currentPage === 1) videoGrid.innerHTML = html;
                else videoGrid.innerHTML += html;
                loadMoreBtn.classList.remove('hidden');
            } else {
                if(currentPage === 1) videoGrid.innerHTML = `<div class="col-span-full text-center text-gray-500 py-10">${CONFIG[currentLang].noResult}</div>`;
            }

            loader.classList.add('hidden');
            refreshIcons(); 
        }

        async function loadMore() {
            currentPage++;
            loadMoreBtn.innerText = CONFIG[currentLang].loading;
            loadMoreBtn.disabled = true;
            await loadHomeView();
            loadMoreBtn.innerText = CONFIG[currentLang].loadMore;
            loadMoreBtn.disabled = false;
        }

        // === LOGIKA PLAYER & URL ID ===

        async function loadPlayerView(id) {
            window.scrollTo(0,0);
            homeView.classList.add('hidden');
            playerView.classList.remove('hidden');

            // Inject Script Iklan Native saat Player Muncul
            loadNativeAd();

            dmPlayer.src = `https://www.dailymotion.com/embed/video/${id}?autoplay=1&queue-enable=false&ui-logo=0&ui-start-screen-info=false&sharing-enable=false`;

            try {
                const response = await fetch(`https://api.dailymotion.com/video/${id}?fields=id,title,owner.username,url,views_total`);
                const data = await response.json();
                
                if(data && !data.error) {
                    document.getElementById('playerTitle').innerText = data.title;
                    document.getElementById('playerOwner').innerText = data['owner.username'];
                    document.getElementById('playerViews').innerText = (data.views_total || 0).toLocaleString() + ' views';
                } else {
                    document.getElementById('playerTitle').innerText = "Video Played from ID";
                }
            } catch(e) { console.log("Metadata error:", e); }

            loadRecommendations(id);
        }

        async function loadRecommendations(currentId) {
            const recList = document.getElementById('recommendationList');
            recList.innerHTML = `<div class="text-center py-4 text-gray-600 text-sm animate-pulse">${CONFIG[currentLang].loading}</div>`;
            
            const randomPage = Math.floor(Math.random() * 5) + 1;
            const recVideos = await fetchDailymotion(CONFIG[currentLang].query, randomPage);
            
            let recHtml = '';
            recVideos.filter(v => v.id !== currentId).slice(0, 10).forEach(v => { 
                recHtml += renderSideItem(v);
            });
            recList.innerHTML = recHtml || '<div class="text-center text-xs text-gray-600">No recommendations</div>';
            refreshIcons();
        }

        function openPlayer(id) {
            updateUrlState(id);
            loadPlayerView(id);
        }

        function goHome() {
            try {
                const newUrl = new URL(window.location);
                newUrl.searchParams.delete('id');
                newUrl.searchParams.set('lang', currentLang); 
                window.history.pushState({ path: newUrl.toString() }, '', newUrl.toString());
            } catch (e) { /* ignore */ }
            
            dmPlayer.src = "";
            homeView.classList.remove('hidden');
            playerView.classList.add('hidden');
        }
        
        function getIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        function shareVideo() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                alert(CONFIG[currentLang].copied);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        function handleSearch(e) {
            e.preventDefault();
            let q = document.getElementById('searchInput').value;
            if(!q) q = document.getElementById('searchInputMobile').value;
            
            q = q.trim();
            if(!q) return;

            const isDailymotionID = /^[xXkK][a-zA-Z0-9]{5,8}$/.test(q);

            if (isDailymotionID) {
                openPlayer(q);
                document.getElementById('searchInput').value = '';
                document.getElementById('searchInputMobile').value = '';
            } else {
                currentQuery = q;
                currentPage = 1;
                isSearchMode = true;
                pageTitle.innerText = `ðŸ” ${q}`;
                
                goHome(); 
                videoGrid.innerHTML = ''; 
                loadHomeView();
            }
        }

        document.getElementById('searchForm').addEventListener('submit', handleSearch);
        document.getElementById('searchFormMobile').addEventListener('submit', handleSearch);

        window.onpopstate = function(event) {
            const id = getIdFromUrl();
            if(id) loadPlayerView(id);
            else {
                dmPlayer.src = "";
                homeView.classList.remove('hidden');
                playerView.classList.add('hidden');
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            init();
        });

    </script>
</body>
</html>
